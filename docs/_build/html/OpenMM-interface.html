

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>OpenMM interface &mdash; Ash 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/my_theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Explicit solvation (small molecule)" href="Explicit-solvation.html" />
    <link rel="prev" title="CREST interface" href="crest-interface.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="index.html" class="icon icon-home"> Ash
          

          
            
            <img src="_static/ash-simple-logo-letterbig.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">ASH</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="About.html">About ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic-examples.html">Basic examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="ash_program_philosophy.html">ASH Program Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="coordinate-input.html">Coordinates and fragments</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallelization.html">Parallelization in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="QM-interfaces.html">QM Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="MM-interfaces.html">MM Interfaces</a></li>
</ul>
<p class="caption"><span class="caption-text">Jobtypes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="job-types.html">Job Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="singlepoint.html">Singlepoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="Geometry-optimization.html">Geometry optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_freq.html">Frequency calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_dynamics.html">Molecular dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="neb.html">Nudged Elastic Band Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="surfacescan.html">Surface Scans</a></li>
</ul>
<p class="caption"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module_QM-MM.html">QM/MM Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_Hybrid_Theory.html">Hybrid Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_benchmarking.html">Benchmarking in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_highlevel_workflows.html">Highlevel workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_molcrys.html">MOLCRYS: Automatic QM/MM for Molecular Crystals</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_PES.html">PES: PhotoElectron/PhotoEmission Spectrum</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_plotting.html">Plotting</a></li>
</ul>
<p class="caption"><span class="caption-text">Interfaces</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="ORCA-interface.html">ORCA interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="xTB-interface.html">xTB interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRCC-interface.html">MRCC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="CFour-interface.html">CFour interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dalton-interface.html">Dalton interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="PySCF-interface.html">PySCF interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Psi4-interface.html">Psi4 interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="crest-interface.html">CREST interface</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">OpenMM interface</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-openmmtheory-class">The OpenMMTheory class</a></li>
<li class="toctree-l2"><a class="reference internal" href="#molecular-dynamics-via-openmm">Molecular Dynamics via OpenMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#pbc-box-relaxation-via-npt">PBC box relaxation via NPT</a></li>
<li class="toctree-l2"><a class="reference internal" href="#simple-minimization-via-openmm">Simple minimization via OpenMM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#system-setup-via-openmm-modeller">System setup via OpenMM: Modeller</a></li>
<li class="toctree-l2"><a class="reference internal" href="#small-molecule-solvation">Small molecule solvation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#create-nonbonded-forcefield-file-for-ligand">Create nonbonded forcefield file for ligand</a></li>
</ul>
</li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Explicit-solvation.html">Explicit solvation (small molecule)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metalloprotein-I.html">Metalloprotein tutorial I: Rubredoxin</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metalloprotein-II.html">Metalloprotein tutorial II: Ferredoxin</a></li>
<li class="toctree-l1"><a class="reference internal" href="QM-MM-protein.html">QM/MM on a protein</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows-examples.html">Workflow examples in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="Highlevel_CC_CBS_workflows.html">Tutorial: High-level CCSD(T)/CBS workflows</a></li>
</ul>
<p class="caption"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="coordinate-tools.html">Coordinates and fragment tools</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ash</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>OpenMM interface</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/OpenMM-interface.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="openmm-interface">
<h1>OpenMM interface<a class="headerlink" href="#openmm-interface" title="Permalink to this headline">¶</a></h1>
<p><a class="reference external" href="https://openmm.org">OpenMM</a> is an open-source molecular mechanics library written in C++. ASH features a flexible interface to the Python API of the OpenMM library.
OpenMM has been designed to run on both CPU and GPU codes with the GPU code being particulary fast.</p>
<div class="section" id="the-openmmtheory-class">
<h2>The OpenMMTheory class<a class="headerlink" href="#the-openmmtheory-class" title="Permalink to this headline">¶</a></h2>
<p>OpenMM can run either on the CPU or on the GPU platform by specifying platform as either: ‘CPU’, ‘OpenCL’ or ‘CUDA’ depending on whether there is a GPU available on the computer.
For platform=’CPU’ the numcores can additionally be specified in order to control the number of CPU cores. Alternatively the shell environment variable OPENMM_CPU_THREADS can be set
to control the number of CPU cores that OpenMM will use. If neither numcores keyword is provided or OPENMM_CPU_THREADS variable set, OpenMM will use the number of physical cores present.</p>
<p>The OpenMMTheory class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">OpenMMTheory</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">printlevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">topoforce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">forcefield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">CHARMMfiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">psffile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charmmtopfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charmmprmfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">GROMACSfiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gromacstopfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">grofile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">gromacstopdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">Amberfiles</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">amberprmtopfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">cluster_fragment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ASH_FF_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PBCvectors</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">xmlfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pdbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_parmed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">xmlsystemfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">do_energy_decomposition</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">periodic</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">charmm_periodic_cell_dimensions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">customnonbondedforce</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">periodic_nonbonded_cutoff</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">dispersion_correction</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">switching_function_distance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">ewalderrortolerance</span><span class="o">=</span><span class="mf">5e-4</span><span class="p">,</span> <span class="n">PMEparameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">delete_QM1_MM1_bonded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">applyconstraints_in_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">constraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">restraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frozen_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dummy_system</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fragment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">autoconstraints</span><span class="o">=</span><span class="s1">&#39;HBonds&#39;</span><span class="p">,</span> <span class="n">hydrogenmass</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">rigidwater</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
</pre></div>
</div>
<p><strong>OpenMMTheory</strong> options:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Keyword</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default value</p></th>
<th class="head"><p>Details</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">printlevel</span></code></p></td>
<td><p>integer</p></td>
<td><p>2</p></td>
<td><p>The printlevel.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">platform</span></code></p></td>
<td><p>string</p></td>
<td><p>‘CPU’</p></td>
<td><p>Run on CPU or GPU. Options: ‘CPU’, ‘OpenCL’, ‘CUDA’</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">numcores</span></code></p></td>
<td><p>integer</p></td>
<td><p>None</p></td>
<td><p>The number of CPU cores to use for ‘CPU’ platform.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">topoforce</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><div class="line-block">
<div class="line">Whether to read in topology and forcefield objects created by</div>
<div class="line">OpenMM manually. Requires setting topology and forcefield also.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">forcefield</span></code></p></td>
<td><p>OpenMM forcefield object</p></td>
<td><p>None</p></td>
<td><p>Read in OpenMM forcefield object defined manually by OpenMM.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">topology</span></code></p></td>
<td><p>OpenMM forcefield object</p></td>
<td><p>None</p></td>
<td><p>Read in OpenMM topology object defined by manually by OpenMM.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">CHARMMfiles</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Read in CHARMM forcefiles or not.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">psffile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of CHARMM protein structure file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">charmmtopfile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>YYYYYYYYYYYY</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">charmmprmfile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of CHARMM parameter file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">GROMACSfiles</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Read in GROMACS forcefiles or not.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gromacstopfile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of the GROMACS topology file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">grofile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of Gromacs coordinate file (.gro extension)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">gromacstopdir</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Path to the GROMACS topology directory.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">Amberfiles</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Read in Amber forcefiles or not.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">amberprmtopfile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of the Amber PRMTOP file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">cluster_fragment</span></code></p></td>
<td><p>Fragment</p></td>
<td><p>None</p></td>
<td><p>ASH Fragment objected created by Molcrys.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">ASH_FF_file</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of ASH forcefield file.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">PBCvectors</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><p>List of lists of floats (nm) or list of OpenMM Vec3 objects. Units are nm.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">xmlfiles</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><p>List of XML-files to read forcefield from.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pdbfile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><div class="line-block">
<div class="line">Name of PDB-file. Used for reading topology for xmlfiles, xmlsystemfile</div>
<div class="line">and ASH_FF_file options.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">use_parmed</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><div class="line-block">
<div class="line">Whether to use Parmed library to help read in CHARMM/Amber/GROMACS</div>
<div class="line">files. Requires install of Parmed Python library.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">xmlsystemfile</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of XML system file to read in.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">do_energy_decomposition</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><div class="line-block">
<div class="line">Do energy decomposition of each energy evaluation</div>
<div class="line">(when called by Singlepoint or optimizer).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">periodic</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Periodic boundary conditions or not.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">charmm_periodic_cell_dimensions</span></code></p></td>
<td><p>None</p></td>
<td><p>None</p></td>
<td><div class="line-block">
<div class="line">Periodic cell dimension for CHARMM-setup of system. Example:</div>
<div class="line">charmm_periodic_cell_dimensions= [200, 200, 200, 90, 90, 90]</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">customnonbondedforce</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><div class="line-block">
<div class="line">Expert option: whether CustomNonbondedForce is used instead</div>
<div class="line">of NonbondedForce.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">periodic_nonbonded_cutoff</span></code></p></td>
<td><p>float</p></td>
<td><p>12.0</p></td>
<td><p>Cutoff for the periodic nonbonding interaction.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">dispersion_correction</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><p>Dispersion correction in periodic nonbonding evaluation.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">switching_function_distance</span></code></p></td>
<td><p>float</p></td>
<td><p>10.0</p></td>
<td><p>Switching function distance in Å units.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">ewalderrortolerance</span></code></p></td>
<td><p>float</p></td>
<td><p>5e-4</p></td>
<td><p>Error tolerance for the periodic electrostatics Ewald algorithm.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">PMEparameters</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><div class="line-block">
<div class="line">Optional manual parameters for the Particle Mess Ewald algorithm.</div>
<div class="line">Alternative to ewalderrortolerance keyword.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">delete_QM1_MM1_bonded</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>For QM/MM job, whether QM1-MM1 are deleted or not.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">applyconstraints_in_run</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Exper option: Whether constraints are applied in run method. Should be False.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">constraints</span></code></p></td>
<td><p>list of lists</p></td>
<td><p>None</p></td>
<td><div class="line-block">
<div class="line">List of lists of constraint definitions based on atom indices. Either</div>
<div class="line">[[atom_i,atom_j]] or [[atom_i,atom_j, d]], e.g. [[700,701],[703,704]]</div>
<div class="line">or [[700,701, 1.05],[702,703, 1.14]], where d: distance (Å))</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">restraints</span></code></p></td>
<td><p>list of lists</p></td>
<td><p>None</p></td>
<td><div class="line-block">
<div class="line">List of lists of restraint definitions ([[atom_i,atom_j, d, k ]], e.g.</div>
<div class="line">[[700,701, 1.05, 5.0 ]], d: distance (Å) k: force constant (kcal/mol*Å^-2))</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">frozen_atoms</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><p>List of atom indices to keep frozen during MD (particle mass set to 0).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">dummy_system</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><div class="line-block">
<div class="line">If True, OpenMM will set up a dummy MM system based on provided fragment</div>
<div class="line">(see below). Used for QM dynamics option in OpenMM_MD.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">fragment</span></code></p></td>
<td><p>ASH Fragment</p></td>
<td><p>None</p></td>
<td><p>ASH fragment to provide when dummy_system is True.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">autoconstraints</span></code></p></td>
<td><p>string</p></td>
<td><p>‘HBonds’</p></td>
<td><div class="line-block">
<div class="line">Type of automatic constraints to apply to system. Options: ‘HBonds’</div>
<div class="line">(constrain all X-H bonds), ‘AllBonds’ (constrain all bonds), ‘HAngles’</div>
<div class="line">(constrain all bonds and  H-X-H and H-O-X angles).</div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">hydrogenmass</span></code></p></td>
<td><p>float</p></td>
<td><p>1.5</p></td>
<td><div class="line-block">
<div class="line">Hydrogen mass repartioning value. 1.5 is OpenMM and ASH default.</div>
<div class="line">Improves numerical stability.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">rigidwater</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><div class="line-block">
<div class="line">Whether to automatically apply rigid water constraints for recognized</div>
<div class="line">water models (e.g. TIP3P) found in system. Note: needs to be turned off for</div>
<div class="line">Singlepoint/Optimizations.</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>It is possible to read in multiple types of forcefield files: AmberFiles, CHARMMFiles, GROMACSFiles or an OpenMM XML forcefieldfile.
Note: In rare cases OpenMM fails to read in Amber/CHARMM/GROMACS files correctly. In those cases the Parmed library may be more successful (use_parmed=True). Requires ParMed (pip install parmed).</p>
<p><em>Example creation of an OpenMMtheory object with CHARMM-files:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">forcefielddir</span><span class="o">=</span><span class="s2">&quot;/path/to/dir&quot;</span>
<span class="n">topfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;top_all36_prot.rtf&quot;</span>
<span class="n">parfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;par_all36_prot.prm&quot;</span>
<span class="n">psffile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;new-XPLOR-psffile.psf&quot;</span>
<span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">CHARMMfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">psffile</span><span class="o">=</span><span class="n">psffile</span><span class="p">,</span> <span class="n">charmmtopfile</span><span class="o">=</span><span class="n">topfile</span><span class="p">,</span>
                           <span class="n">charmmprmfile</span><span class="o">=</span><span class="n">parfile</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Example creation of an OpenMMtheory object with GROMACS-files:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">GROMACSfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gromacstopdir</span><span class="o">=</span><span class="s2">&quot;/path/to/gromacstopdir&quot;</span><span class="p">,</span>
                <span class="n">gromacstopfile</span><span class="o">=</span><span class="s2">&quot;gromacstopfile.top&quot;</span><span class="p">,</span> <span class="n">grofile</span><span class="o">=</span><span class="s2">&quot;grofile.gro&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Example creation of an OpenMMtheory object with AMBER files:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">Amberfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">amberprmtopfile</span><span class="o">=</span><span class="s2">&quot;/path/to/amberprmtopfile&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><em>Example creation of an OpenMMtheory object with OpenMM XML file:</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">xmlfiles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;example.xml&quot;</span><span class="p">])</span> <span class="c1">#File example.xml should be in dir</span>
<span class="c1">#or</span>
<span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">xmlfiles</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;charmm36.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;charmm36/water.xml&quot;</span><span class="p">,</span> <span class="s2">&quot;specialresidue.xml&quot;</span><span class="p">])</span>
<span class="c1">#Here the &quot;charmm36.xml&quot; and &quot;charmm36/water.xml&quot; files are found in the OpenMM library.</span>
</pre></div>
</div>
<p>Any Openmmtheory object can used to create a QM/MM theory object. See <a class="reference internal" href="module_QM-MM.html"><span class="doc">QM/MM Theory</span></a> page.</p>
<p><strong>Periodic boundary conditions:</strong></p>
<ul class="simple">
<li><p>If periodic boundary conditions are chosen (periodic=True) then the PBC box parameters are automatically found in the Amber PRMTOP file or the GROMACS Grofile or in the case of CHARMM-files they need to be provided: charmm_periodic_cell_dimensions</p></li>
<li><p>The Ewald error tolerance (ewalderrortolerance) can be modified (default: 5e-4)</p></li>
<li><p>PME parameters can be modified: PMEparameters=[alpha_separation,numgridpoints_X,numgridpoints_Y,numgridpoints_Z]</p></li>
<li><p>The periodic nonbonded cutoff can be modified. Default: 12 Å</p></li>
<li><p>Long-range dispersion correction can be turned on or off. Default: True</p></li>
<li><p>The switching function distance can be changed. Default: 10 Å. Used for CHARMM and XML files.</p></li>
<li><dl class="simple">
<dt>The box dimensions can also be modified by PBCvectors= keyword argument:</dt><dd><p>Example: PBCvectors=[[x1,y1,z1],[x2,y2,z2],[x3,y3,z3]] with values in Å.</p>
</dd>
</dl>
</li>
</ul>
</div>
<div class="section" id="molecular-dynamics-via-openmm">
<h2>Molecular Dynamics via OpenMM<a class="headerlink" href="#molecular-dynamics-via-openmm" title="Permalink to this headline">¶</a></h2>
<p>It is possible to run molecular dynamics of an ASH system using the MD algorithms present in the OpenMM library.
The OpenMM_MD function takes as argument an ASH fragment, a theory object and the user then selects an integrator of choice, simulation temperature, simulation length, timestep, optional additional thermostat, barostat etc.
The theory level can be OpenMMTheory, QMMMTheory or even a simple QMTheory.
Some options are only available for OpenMMTheory.</p>
<p>See <a class="reference external" href="http://docs.openmm.org/latest/userguide/application.html#integrators">OpenMM documentation page</a>  for details about the integrators, thermostats, barostats etc.</p>
<ul class="simple">
<li><p>Available Integrators: Langevin, LangevinMiddleIntegrator, NoseHooverIntegrator, VerletIntegrator, VariableLangevinIntegrator, VariableVerletIntegrator</p></li>
<li><p>Available Barostat: MonteCarloBarostat</p></li>
<li><p>Optional additional thermostat: Anderson</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">OpenMM_MD</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span> <span class="n">simulation_steps</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">simulation_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">traj_frequency</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;LangevinMiddleIntegrator&#39;</span><span class="p">,</span>
            <span class="n">barostat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pressure</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trajectory_file_option</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">,</span> <span class="n">trajfilename</span><span class="o">=</span><span class="s1">&#39;trajectory&#39;</span><span class="p">,</span>
            <span class="n">coupling_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">anderson_thermostat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">enforcePeriodicBox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dummyatomrestraint</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">center_on_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solute_indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">datafilename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dummy_MM</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plumed_object</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">add_center_force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">center_force_atoms</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">centerforce_constant</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">barostat_frequency</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">specialbox</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</pre></div>
</div>
<p><strong>OpenMM_MD</strong> options:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 14%" />
<col style="width: 57%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Keyword</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Default value</p></th>
<th class="head"><p>Details</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">fragment</span></code></p></td>
<td><p>ASH Fragment</p></td>
<td><p>None</p></td>
<td><p>The ASH fragment.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">theory</span></code></p></td>
<td><p>ASH Theory</p></td>
<td><p>None</p></td>
<td><p>The ASH Theory object.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">timestep</span></code></p></td>
<td><p>float</p></td>
<td><p>0.004</p></td>
<td><div class="line-block">
<div class="line">The timestep . Default: 0.004 ps (suitable for LangevinMiddleIntegrator</div>
<div class="line">dynamics with frozen X-H bonds)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">simulation_steps</span></code></p></td>
<td><p>integer</p></td>
<td><p>None</p></td>
<td><p>Number of simulation steps to take. Alternative to simulation_time below</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">simulation_time</span></code></p></td>
<td><p>float</p></td>
<td><p>None</p></td>
<td><p>Length of simulation in picoseconds. Alternative to simulation_time above.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">temperature</span></code></p></td>
<td><p>integer</p></td>
<td><p>300</p></td>
<td><p>The temperature in Kelvin.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">integrator</span></code></p></td>
<td><p>string</p></td>
<td><p>LangevinMiddleIntegrator</p></td>
<td><div class="line-block">
<div class="line">The integrator to use. Options: ‘Langevin’, ‘LangevinMiddleIntegrator’,</div>
<div class="line">‘NoseHooverIntegrator’, ‘VerletIntegrator’, ‘VariableLangevinIntegrator’,</div>
<div class="line">‘VariableVerletIntegrator’</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">coupling_frequency</span></code></p></td>
<td><p>integer</p></td>
<td><p>1</p></td>
<td><p>The coupling frequency of thermostat (in ps^-1 for Nosé-Hoover and Langevin-type)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">barostat</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Barostat to use for NPT simulations. Options: ‘MonteCarloBarostat’</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">barostat_frequency</span></code></p></td>
<td><p>int</p></td>
<td><p>25</p></td>
<td><p>Frequency of barostat update.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">pressure</span></code></p></td>
<td><p>int</p></td>
<td><p>1</p></td>
<td><p>Pressure to enforce by barostat</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">anderson_thermostat</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Whether to use Andersen Thermostat</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">trajectory_file_option</span></code></p></td>
<td><p>string</p></td>
<td><p>‘DCD’</p></td>
<td><div class="line-block">
<div class="line">Type of trajectory file. Options: ‘DCD’ (compressed), ‘PDB’, ‘NetCDFReporter’</div>
<div class="line">(compressed), ‘HDF5Reporter’ (compressed). Applies only to pure MM simulations.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">traj_frequency</span></code></p></td>
<td><p>integer</p></td>
<td><p>1000</p></td>
<td><p>Frequency of writing trajectory (every Xth timestep).</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">trajfilename</span></code></p></td>
<td><p>string</p></td>
<td><p>None</p></td>
<td><p>Name of trajectory file (without suffix).</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">enforcePeriodicBox</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>True</p></td>
<td><p>Enforce PBC image during simulation. Fixes PBC-image artifacts in trajectory.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">center_on_atoms</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><p>Expert options: Center system on these atoms.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">dummyatomrestraint</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Expert options: Dummy atom restraints.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">solute_indices</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><p>Expert options: solute_indices</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">add_center_force</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Whether to add a spherical force that pushes atoms to the center.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">center_force_atoms</span></code></p></td>
<td><p>list</p></td>
<td><p>None</p></td>
<td><p>List of atom indices that the center force acts on.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">centerforce_constant</span></code></p></td>
<td><p>float</p></td>
<td><p>None</p></td>
<td><p>Value of the spherical center force in kcal/mol/Ang^2.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">specialbox</span></code></p></td>
<td><p>Boolean</p></td>
<td><p>False</p></td>
<td><p>Expert option: Special box for QM/MM.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">plumed_object</span></code></p></td>
<td><p>ASH-Plumed object</p></td>
<td><p>None</p></td>
<td><p>Expert option: Plumed object for biased dynamics.</p></td>
</tr>
</tbody>
</table>
<p>Note that constraints, autoconstraints, restraints and frozen_atoms must be defined in the OpenMMTHeory object before.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Forcefield parameters</span>
<span class="n">forcefielddir</span><span class="o">=</span><span class="s2">&quot;/home/bjornsson/ASH-DEV_GIT/testsuite/OpenMM-files-for-tests/dhfr/charmm/&quot;</span>
<span class="n">psffile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;step3_pbcsetup.psf&quot;</span>
<span class="n">topfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;top_all36_prot.rtf&quot;</span>
<span class="n">prmfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;par_all36_prot.prm&quot;</span>

<span class="c1">#Defining fragment</span>
<span class="n">xyzfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;file.xyz&quot;</span>
<span class="n">frag</span> <span class="o">=</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">xyzfile</span><span class="o">=</span><span class="n">xyzfile</span><span class="p">,</span> <span class="n">conncalc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">#Defining OpenMM theory object: CHARMM forcefield with periodic boundary conditions</span>
<span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">psffile</span><span class="o">=</span><span class="n">psffile</span><span class="p">,</span> <span class="n">CHARMMfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charmmtopfile</span><span class="o">=</span><span class="n">topfile</span><span class="p">,</span>
    <span class="n">charmmprmfile</span><span class="o">=</span><span class="n">prmfile</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charmm_periodic_cell_dimensions</span><span class="o">=</span><span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span>
    <span class="n">dispersion_correction</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">periodic_nonbonded_cutoff</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">switching_function_distance</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="n">PMEparameters</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">0.34</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>

<span class="c1">#Launching a molecular dynamics simulation</span>
<span class="n">OpenMM_MD</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">frag</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">simulation_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">traj_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;LangevinMiddleIntegrator&#39;</span><span class="p">,</span> <span class="n">coupling_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trajectory_file_option</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>General constraints or H-mass modification:</strong></p>
<ul class="simple">
<li><p>In order to allow shorter timesteps in MD simulations it is common to utilize some general constraints in biomolecular simulations, e.g. all X-H bonds, all bonds or even all-bond and some angles. This can be accomplished  via the autoconstraints option (NOTE: an option to OpenMMTheory). autoconstraints can be set to: ‘HBonds’ (X-H bonds constrained), ‘AllBonds’ (all bonds constrained), ‘HAngles’ (all bonds and H-X-H and H-O-X angles constrained) or None (default)</p></li>
<li><p>An alternative (or addition) is to change the masses of the hydrogen atoms (fastest-moving atoms). This is also an option to OpenMMTheory. hydrogenmass keyword takes an integer and can e.g. be 2 (mass of deuterium) or heavier. hydrogenmass=1.5 is default (default in OpenMM) .</p></li>
</ul>
<p>General X-H constraints and deuterium-mass example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Forcefield parameters</span>
<span class="n">forcefielddir</span><span class="o">=</span><span class="s2">&quot;/home/bjornsson/ASH-DEV_GIT/testsuite/OpenMM-files-for-tests/dhfr/charmm/&quot;</span>
<span class="n">psffile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;step3_pbcsetup.psf&quot;</span>
<span class="n">topfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;top_all36_prot.rtf&quot;</span>
<span class="n">prmfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;par_all36_prot.prm&quot;</span>

<span class="c1">#Defining fragment</span>
<span class="n">xyzfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;file.xyz&quot;</span>
<span class="n">frag</span> <span class="o">=</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">xyzfile</span><span class="o">=</span><span class="n">xyzfile</span><span class="p">,</span> <span class="n">conncalc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">#Defining OpenMM theory object: CHARMM forcefield with periodic boundary conditions</span>
<span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">psffile</span><span class="o">=</span><span class="n">psffile</span><span class="p">,</span> <span class="n">CHARMMfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charmmtopfile</span><span class="o">=</span><span class="n">topfile</span><span class="p">,</span>
    <span class="n">charmmprmfile</span><span class="o">=</span><span class="n">prmfile</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charmm_periodic_cell_dimensions</span><span class="o">=</span><span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">],</span> <span class="n">autoconstraints</span><span class="o">=</span><span class="s1">&#39;HBonds&#39;</span><span class="p">,</span> <span class="n">hydrogenmass</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="c1">#Launching a molecular dynamics simulation</span>
<span class="n">OpenMM_MD</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">frag</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">simulation_steps</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">traj_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;LangevinMiddleIntegrator&#39;</span><span class="p">,</span> <span class="n">coupling_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trajectory_file_option</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Dealing with PBC image problems in trajectory. See <a class="reference external" href="https://github.com/openmm/openmm/wiki/Frequently-Asked-Questions#how-do-periodic-boundary-conditions-work">OpenMM FAQ</a>
To obtain a more pleasing visualization of the trajectory you can “reimage” the trajectory afterwards using the program mdtraj (requires installation of mdtraj: pip install mdtraj)</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1">#Provide trajectory file, PDB topology file and final format of trajectory</span>
<span class="n">MDtraj_imagetraj</span><span class="p">(</span><span class="s2">&quot;output_traj.dcd&quot;</span><span class="p">,</span> <span class="s2">&quot;final_MDfrag_laststep.pdb&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">)</span>

<span class="c1">#If periodic box info is missing from trajectory file (can happen with CHARMM files):</span>
<span class="n">MDtraj_imagetraj</span><span class="p">(</span><span class="s2">&quot;out&quot;</span><span class="p">,</span> <span class="n">pdbtopology</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">,</span> <span class="n">unitcell_lengths</span><span class="o">=</span><span class="p">[</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">,</span><span class="mf">100.0</span><span class="p">],</span> <span class="n">unitcell_angles</span><span class="o">=</span><span class="p">[</span><span class="mf">90.0</span><span class="p">,</span><span class="mf">90.0</span><span class="p">,</span><span class="mf">90.0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="pbc-box-relaxation-via-npt">
<h2>PBC box relaxation via NPT<a class="headerlink" href="#pbc-box-relaxation-via-npt" title="Permalink to this headline">¶</a></h2>
<p>This function allows one to conveniently run multiple NPT simulations (constant pressure and temperature) in order to converge the periodic box dimensions
of the system.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">OpenMM_box_relaxation</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">datafilename</span><span class="o">=</span><span class="s2">&quot;nptsim.csv&quot;</span><span class="p">,</span> <span class="n">numsteps_per_NPT</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
                          <span class="n">volume_threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">density_threshold</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.004</span><span class="p">,</span>
                          <span class="n">traj_frequency</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">trajfilename</span><span class="o">=</span><span class="s1">&#39;relaxbox_NPT&#39;</span><span class="p">,</span> <span class="n">trajectory_file_option</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">,</span> <span class="n">coupling_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;NPT simulations until volume and density stops changing</span>

<span class="sd">    Args:</span>
<span class="sd">        fragment ([type], optional): [description]. Defaults to None.</span>
<span class="sd">        theory ([type], optional): [description]. Defaults to None.</span>
<span class="sd">        datafilename (str, optional): [description]. Defaults to &quot;nptsim.csv&quot;.</span>
<span class="sd">        numsteps_per_NPT (int, optional): [description]. Defaults to 10000.</span>
<span class="sd">        volume_threshold (float, optional): [description]. Defaults to 1.0.</span>
<span class="sd">        density_threshold (float, optional): [description]. Defaults to 0.001.</span>
<span class="sd">        temperature (int, optional): [description]. Defaults to 300.</span>
<span class="sd">        timestep (float, optional): [description]. Defaults to 0.004.</span>
<span class="sd">        traj_frequency (int, optional): [description]. Defaults to 100.</span>
<span class="sd">        trajectory_file_option (str, optional): [description]. Defaults to &#39;DCD&#39;.</span>
<span class="sd">        coupling_frequency (int, optional): [description]. Defaults to 1.</span>
<span class="sd">    &quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="simple-minimization-via-openmm">
<h2>Simple minimization via OpenMM<a class="headerlink" href="#simple-minimization-via-openmm" title="Permalink to this headline">¶</a></h2>
<p>A classical system setup typically requires a minimization to get rid of large initial forces related to non-ideal atom positions.
The simple minimizer in the OpenMM library works well for this purpose although achieving convergence can be difficult.
Typically a few 100-1000 steps of minimization is sufficient to get rid of the major forces.</p>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Forcefield parameters</span>
<span class="n">forcefielddir</span><span class="o">=</span><span class="s2">&quot;/home/bjornsson/ASH-DEV_GIT/testsuite/OpenMM-files-for-tests/dhfr/charmm/&quot;</span>
<span class="n">psffile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;step3_pbcsetup.psf&quot;</span>
<span class="n">topfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;top_all36_prot.rtf&quot;</span>
<span class="n">prmfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;par_all36_prot.prm&quot;</span>

<span class="c1">#Defining fragment</span>
<span class="n">xyzfile</span><span class="o">=</span><span class="n">forcefielddir</span><span class="o">+</span><span class="s2">&quot;file.xyz&quot;</span>
<span class="n">frag</span> <span class="o">=</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">xyzfile</span><span class="o">=</span><span class="n">xyzfile</span><span class="p">,</span> <span class="n">conncalc</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1">#Defining OpenMM theory object: CHARMM forcefield with periodic boundary conditions</span>
<span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">psffile</span><span class="o">=</span><span class="n">psffile</span><span class="p">,</span> <span class="n">CHARMMfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charmmtopfile</span><span class="o">=</span><span class="n">topfile</span><span class="p">,</span>
    <span class="n">charmmprmfile</span><span class="o">=</span><span class="n">prmfile</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">charmm_periodic_cell_dimensions</span><span class="o">=</span><span class="p">[</span><span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">])</span>

<span class="c1">#Launching a minimization</span>
<span class="n">OpenMM_Opt</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">frag</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1">#After minimization, the ASH fragment is updated, a PDB-file is written out: frag-minimized.pdb</span>
<span class="c1">#Alternative XYZ write-out:</span>
<span class="n">frag</span><span class="o">.</span><span class="n">write_xyzfile</span><span class="p">(</span><span class="n">xyzfilename</span><span class="o">=</span><span class="s2">&quot;frag_afteropt.xyz&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>If you want to do a simple minimization of only the H-atoms of your system (e.g. your protein with newly added H-atoms),
you can do this by freezing all non-H atoms. An ASH fragment can conveniently give you lists of atom indices by the built-in functions:</p>
<ul class="simple">
<li><p>fragment.get_atomindices_for_element(‘C’)   #List of atom-indices for carbon atoms in the system</p></li>
<li><p>fragment.get_atomindices_except_element(‘H’)   #List of atom-indices for all atoms except the chosen element (here H).</p></li>
</ul>
<p>Note: all constraints in the OpenMM object needs to be turned off for (autoconstraints=None, rigidwater=False) for this many frozen atoms (frozen atoms can not have constraints).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>


<span class="n">pdbfile</span> <span class="o">=</span> <span class="s2">&quot;ash_inp.pdb&quot;</span>
<span class="n">prmtopfile</span> <span class="o">=</span> <span class="s2">&quot;prmtop&quot;</span>

<span class="n">frag</span> <span class="o">=</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">pdbfile</span><span class="o">=</span><span class="n">pdbfile</span><span class="p">)</span>

<span class="c1">#List of all non-H atoms</span>
<span class="n">allnonHatoms</span><span class="o">=</span><span class="n">frag</span><span class="o">.</span><span class="n">get_atomindices_except_element</span><span class="p">(</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>

<span class="n">openmmobject</span> <span class="o">=</span> <span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">Amberfiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">amberprmtopfile</span><span class="o">=</span><span class="n">prmtopfile</span><span class="p">,</span> <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span><span class="p">,</span> <span class="n">autoconstraints</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rigidwater</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">frozen_atoms</span><span class="o">=</span><span class="n">allnonHatoms</span><span class="p">)</span>

<span class="n">OpenMM_Opt</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">frag</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="system-setup-via-openmm-modeller">
<h2>System setup via OpenMM: Modeller<a class="headerlink" href="#system-setup-via-openmm-modeller" title="Permalink to this headline">¶</a></h2>
<p>OpenMM features a convenient a <a class="reference external" href="https://github.com/openmm/pdbfixer">PDBfixer program</a> and  <a class="reference external" href="http://docs.openmm.org/latest/api-python/generated/simtk.openmm.app.modeller.Modeller.html">Modeller tool</a>
that together are capable of setting up a new biomolecular system from scratch. See also <a class="reference external" href="http://docs.openmm.org/7.2.0/userguide/application.html#model-building-and-editing">OpenMM-Model-building and editing</a>
As ASH features a highly convenient interface to these programs and OpenMM itself this allows near-automatic system-setup for biomolecular systems.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">OpenMM_Modeller</span><span class="p">(</span><span class="n">pdbfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">forcefield</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">xmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">waterxmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">watermodel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
                    <span class="n">solvent_padding</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">solvent_boxdims</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extraxmlfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">residue_variants</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">ionicstrength</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">pos_iontype</span><span class="o">=</span><span class="s1">&#39;Na+&#39;</span><span class="p">,</span> <span class="n">neg_iontype</span><span class="o">=</span><span class="s1">&#39;Cl-&#39;</span><span class="p">,</span> <span class="n">platform</span><span class="o">=</span><span class="s1">&#39;CPU&#39;</span><span class="p">):</span>
</pre></div>
</div>
<p>The OpenMM_Modeller function returns an ASH OpenMMTheory object and ASH fragment object that can be used directly as theory level for future calculations.
OpenMM_Modeller will also print various PDB-files associated with each step of the setup (H-addition, solvation, ionization etc.) that can be visualized for correctness.
An XML file associated with the system is created that can be used to create future OpenMMtheory objects from.</p>
<p>Lysozyme example (simple, no modifications required):</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Original raw PDB-file (no hydrogens, nosolvent)</span>
<span class="c1">#Download from https://www.rcsb.org/structure/1AKI</span>
<span class="n">pdbfile</span><span class="o">=</span><span class="s2">&quot;1aki.pdb&quot;</span>


<span class="c1">#Defining residues with special user-wanted protonation states for residues in each indicated chain</span>
<span class="c1">#Dictionary of dictionaries with the chainname (e.g. &#39;A&#39;,&#39;B&#39;) acting as keys for the outer dictionary</span>
<span class="c1">#and the resids being keys for the inner dictionary</span>
<span class="c1">#Example: residue_variants={&#39;A&#39;:{0:&#39;LYN&#39;, 17:&#39;CYX&#39;, 18:&#39;ASH&#39;, 19:&#39;HIE&#39;, 20:&#39;HID&#39;, 21:&#39;GLH&#39; }}</span>
<span class="c1">#resid 1: neutral LYS, resid 17, deprotonated CYS, resid 18 protonated ASP,</span>
<span class="c1">#resid 19 epsilon-protonated HIS, resid 20 delta-protonated HIS, 21 protonated GLU.</span>
<span class="n">residue_variants</span><span class="o">=</span><span class="p">{}</span>

<span class="c1">#Setting up new system, adding hydrogens, solvent, ions and defining forcefield, topology</span>
<span class="n">openmmobject</span><span class="p">,</span> <span class="n">ashfragment</span> <span class="o">=</span> <span class="n">OpenMM_Modeller</span><span class="p">(</span><span class="n">pdbfile</span><span class="o">=</span><span class="n">pdbfile</span><span class="p">,</span> <span class="n">forcefield</span><span class="o">=</span><span class="s1">&#39;CHARMM36&#39;</span><span class="p">,</span> <span class="n">watermodel</span><span class="o">=</span><span class="s2">&quot;tip3p&quot;</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
    <span class="n">solvent_padding</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">ionicstrength</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">residue_variants</span><span class="o">=</span><span class="n">residue_variants</span><span class="p">)</span>

<span class="c1">#MM minimization for 100 steps</span>
<span class="n">OpenMM_Opt</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">ashfragment</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Classical MD simulation for 10 ps</span>
<span class="n">OpenMM_MD</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">ashfragment</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">timestep</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">simulation_time</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">traj_frequency</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
    <span class="n">integrator</span><span class="o">=</span><span class="s1">&#39;LangevinMiddleIntegrator&#39;</span><span class="p">,</span> <span class="n">coupling_frequency</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">trajectory_file_option</span><span class="o">=</span><span class="s1">&#39;DCD&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>If the protein contains nonstandard residues (e.g. metallocofactors) that are not present in a typical protein forcefield (OpenMM_Modeller will exit with errors),
then these need to be provided using the extraxmlfile option.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">openmmobject</span><span class="p">,</span> <span class="n">ashfragment</span> <span class="o">=</span> <span class="n">OpenMM_Modeller</span><span class="p">(</span><span class="n">pdbfile</span><span class="o">=</span><span class="n">pdbfile</span><span class="p">,</span> <span class="n">forcefield</span><span class="o">=</span><span class="s1">&#39;CHARMM36&#39;</span><span class="p">,</span> <span class="n">watermodel</span><span class="o">=</span><span class="s2">&quot;tip3p&quot;</span><span class="p">,</span> <span class="n">pH</span><span class="o">=</span><span class="mf">7.0</span><span class="p">,</span>
    <span class="n">solvent_padding</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">ionicstrength</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">residue_variants</span><span class="o">=</span><span class="n">residue_variants</span><span class="p">,</span> <span class="n">extraxmlfile</span><span class="o">=</span><span class="s2">&quot;cofactor.xml&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The cofactor.xml file needs to define a forcefield (a nonbonded one at least) for the residue.
Here defining a simple Fe(III) ion:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>&lt;ForceField&gt;
&lt;AtomTypes&gt;
&lt;Type name=&quot;FEX&quot; class=&quot;Fe&quot; element=&quot;Fe&quot; mass=&quot;55.84700&quot;/&gt;
&lt;/AtomTypes&gt;
&lt;Residues&gt;
&lt;Residue name=&quot;FE&quot;&gt;
&lt;Atom name=&quot;FE&quot; type=&quot;FEX&quot;/&gt;
&lt;/Residue&gt;
&lt;/Residues&gt;
&lt;NonbondedForce coulomb14scale=&quot;1.0&quot; lj14scale=&quot;1.0&quot;&gt;
&lt;Atom type=&quot;FEX&quot; charge=&quot;3.0&quot; sigma=&quot;1.3&quot; epsilon=&quot;0.0&quot;/&gt;
&lt;/NonbondedForce&gt;
&lt;LennardJonesForce lj14scale=&quot;1.0&quot;&gt;
&lt;Atom type=&quot;FEX&quot; sigma=&quot;0.3&quot; epsilon=&quot;0.00000&quot;/&gt;
&lt;/LennardJonesForce&gt;
&lt;/ForceField&gt;
</pre></div>
</div>
<p>See e.g. <a class="reference external" href="https://education.molssi.org/mm-tools/01-introduction/index.html">Molecular Mechanics Tools</a> for information on the format of the XML file.
See also information on the <strong>write_nonbonded_FF_for_ligand</strong> function on this page.</p>
<p>See <a class="reference internal" href="#"><span class="doc">OpenMM interface</span></a> for details and the <a class="reference internal" href="Metalloprotein-I.html"><span class="doc">Metalloprotein tutorial I: Rubredoxin</span></a> and <a class="reference internal" href="Metalloprotein-II.html"><span class="doc">Metalloprotein tutorial II: Ferredoxin</span></a> for step-by-step tutorials on the rubredoxin and ferredoxin metalloproteins.</p>
<p>Common error messages encountered when using OpenMM_Modeller on PDB-files:</p>
<p>-<strong>ValueError: No template found for residue X (YYY).  This might mean your input topology is missing some atoms or bonds, or possibly that you are using the wrong force field.</strong></p>
<p><em>This means that the parser encountered a completely unknown residue. You might have forgotten to read in the XML file to OpenMM_Modeller or the resname is not the same in the PDBfile as in the XML file. The atomnames and residue name in PDB-file must match the atomnames and residue name in the XML file. Also, element information (column 77-78) must be present in the PDB-file.
It is also possible that PDB-file does not contain a valid N- or C-terminus for each peptide chain. Note that for a C-terminus, a terminal oxygen atom with atomname OXT is required.</em></p>
<ul class="simple">
<li><p><strong>ValueError: Found multiple definitions for atom type: X</strong>  :</p></li>
</ul>
<p><em>This means that the atomtypes you defined inside &lt;AtomTypes&gt; &lt;/AtomTypes&gt; are not unique. Either you have accidentally two lines with the same name for atomtype or the general forcefield (e.g. CHARMM) already contains an atomtype definition with this name. In that case, choose a unique name.</em></p>
<ul class="simple">
<li><p><strong>KeyError: ‘SXM’</strong>  :</p></li>
</ul>
<p><em>Possibly means that your atomname definition points to an atomtype-name that does not exist</em></p>
<ul class="simple">
<li><p><strong>ValueError: No template found for residue X (YYY).  The set of atoms matches YYY, but the bonds are different.  Perhaps the chain is missing a terminal group?’</strong>  :</p></li>
</ul>
<p><em>This means there is some mismatch between the information present in the PDB-file and the information in the XML-file you provided.
It’s possible that the PDB-file contains connectivity statements at the bottom of the PDB-file (CONE lines) but no bond information is present in the XML file.
Solution: Either add the missing bond to the residue definition so that it matches the CONE lines or simply delete the CONE information that you don’t need.</em></p>
<p>Valid alternative residue names for alternative protonation states of titratable residues:</p>
<ul class="simple">
<li><p>LYN instead of LYS: deprotonated lysine residue (NH2 instead of NH3)</p></li>
<li><p>CYX instead of CYS: deprotonated cysteine residue (S- instead of SH)</p></li>
<li><p>ASH instead of ASP: protonated aspartate residue (COOH instead of COO-)</p></li>
<li><p>GLH instead of GLU: protonated glutamate residue (COOH instead of COO-)</p></li>
<li><p>HID instead of HIS: histidine protonated at delta nitrogen</p></li>
<li><p>HIE instead of HIS: histidine protonated at epsilon nitrogen</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Note: these names should not be used in the PDB-file. Only in the residue_variants dictionary that you provide to OpenMM_Modeller.</p>
</div>
</div>
<div class="section" id="small-molecule-solvation">
<h2>Small molecule solvation<a class="headerlink" href="#small-molecule-solvation" title="Permalink to this headline">¶</a></h2>
<p><strong>WORK IN PROGRESS</strong></p>
<p>ASH also features a function to solvate a small molecule automatically. This also makes use of the Modeller functionality of OpenMM but is intended to be used for molecules
for where forcefield parameters are typically not available: e.g. metal complexes. Instead of regular forcefield parameters, nonbonded parameters (charges and Lennard-Jones parameters)
are defined for the solute (used for classical and QM/MM simulations) which can be used to perfrom classical MM dynamics or QM/MM dynamics.</p>
<p>See also <a class="reference internal" href="Explicit-solvation.html"><span class="doc">Explicit solvation (small molecule)</span></a> workflow page.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">solvate_small_molecule</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">watermodel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">solvent_boxdims</span><span class="o">=</span><span class="p">[</span><span class="mf">70.0</span><span class="p">,</span><span class="mf">70.0</span><span class="p">,</span><span class="mf">70.0</span><span class="p">],</span>
                           <span class="n">nonbonded_pars</span><span class="o">=</span><span class="s2">&quot;CM5_UFF&quot;</span><span class="p">,</span> <span class="n">orcatheory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
</pre></div>
</div>
<p>The solvate_small_molecule function reads in an ASH fragment, as well as charge and multiplicity, name of watermodel (e.g. “TIP3P”), size of solvent box, option for
how the nonbonded parameters should be prepared, an optional ORCATheory object and optional numcores.</p>
<p>Options:</p>
<ul class="simple">
<li><p>watermodel (string). Can be: ‘TIP3P’ only for now</p></li>
<li><p>solvent_boxdims (list of floats). Cubic box dimensions in Angstrom.</p></li>
<li><p>nonbonded_pars (string). Options: ‘CM5_UFF’, ‘DDEC3’, ‘DDEC6’ or ‘xtb_UFF’</p></li>
<li><p>orcatheory (ORCATheory object). Optional ORCAtheory object defining the theory for deriving charges/LJ parameters</p></li>
<li><p>numcores (integer). Number of cores used in ORCA/xTB calculations</p></li>
</ul>
<p>nonbonded_pars options:</p>
<ul class="simple">
<li><p>‘CM5_UFF’ derives CM5 charges (scaled Hirshfeld charges) from an ORCA calculation of the molecule and uses UFF Lennard-Jones parameters</p></li>
<li><p>‘DDEC3’ and ‘DDEC6’ derive both charges and LJ parameters from an ORCA calculation. Uses the Chargemol program.</p></li>
<li><p>‘xtb_UFF’ performs an xTB calculation to derive charges and uses UFF for LJ.</p></li>
</ul>
<p>Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">numcores</span><span class="o">=</span><span class="mi">4</span>
<span class="c1">#Molecule definition</span>
<span class="n">mol</span><span class="o">=</span><span class="n">Fragment</span><span class="p">(</span><span class="n">xyzfile</span><span class="o">=</span><span class="s2">&quot;3fgaba.xyz&quot;</span><span class="p">)</span>
<span class="n">mol</span><span class="o">.</span><span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">mol</span><span class="o">.</span><span class="n">mult</span><span class="o">=</span><span class="mi">1</span>

<span class="c1">#Solvate molecule (70x70x70 Å TIP3P box)</span>
<span class="n">forcefield</span><span class="p">,</span> <span class="n">topology</span><span class="p">,</span> <span class="n">ashfragment</span> <span class="o">=</span> <span class="n">solvate_small_molecule</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">mol</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">charge</span><span class="p">,</span>
    <span class="n">mult</span><span class="o">=</span><span class="n">mol</span><span class="o">.</span><span class="n">mult</span><span class="p">,</span> <span class="n">watermodel</span><span class="o">=</span><span class="s1">&#39;tip3p&#39;</span><span class="p">,</span> <span class="n">solvent_boxdims</span><span class="o">=</span><span class="p">[</span><span class="mi">70</span><span class="p">,</span><span class="mi">70</span><span class="p">,</span><span class="mi">70</span><span class="p">],</span> <span class="n">nonbonded_pars</span><span class="o">=</span><span class="s2">&quot;CM5_UFF&quot;</span><span class="p">,</span>
    <span class="n">numcores</span><span class="o">=</span><span class="n">numcores</span><span class="p">)</span>
</pre></div>
</div>
<p>The output of the solvate_small_molecule function are files: “system_aftersolvent.pdb”, “newfragment.ygg”, “newfragment.xyz” that can be used to inspect the coordinates of the system.</p>
<p>Additionally the function returns an OpenMM forcefield object, an OpenMM topology and an ASH fragment. These can be used in a next step to create an OpenMMTheory object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Creating new OpenMM object from forcefield, topology and and fragment</span>
<span class="n">openmmobject</span> <span class="o">=</span><span class="n">OpenMMTheory</span><span class="p">(</span><span class="n">numcores</span><span class="o">=</span><span class="n">numcores</span><span class="p">,</span> <span class="n">Modeller</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">forcefield</span><span class="o">=</span><span class="n">forcefield</span><span class="p">,</span> <span class="n">topology</span><span class="o">=</span><span class="n">topology</span><span class="p">,</span>
                <span class="n">periodic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoconstraints</span><span class="o">=</span><span class="s1">&#39;HBonds&#39;</span><span class="p">,</span> <span class="n">rigidwater</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The OpenMMTheory object can then be used on its own or can be combined with a QM theory to define a QM/MM theory object etc.
See <a class="reference internal" href="Explicit-solvation.html"><span class="doc">Explicit solvation (small molecule)</span></a> workflow for more information on how to use solvate_small_molecule in a multi-step workflow.</p>
</div>
<div class="section" id="create-nonbonded-forcefield-file-for-ligand">
<h2>Create nonbonded forcefield file for ligand<a class="headerlink" href="#create-nonbonded-forcefield-file-for-ligand" title="Permalink to this headline">¶</a></h2>
<p>ASH features a function (<strong>write_nonbonded_FF_for_ligand</strong>) that allows one to quickly
create an XML forcefield file for any residue based on xTB-derived or DFT-derived atomic charges (CM5 charges) together with element-specific
Lennard-Jones parameters.</p>
<p>DFT-example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>from ash import *

frag=Fragment(xyzfile=&quot;ligand.xyz&quot;)

#Script to get nonbonded model parameters for a ligand
orcatheory=ORCATheory(orcasimpleinput=&quot;!r2scan ZORA ZORA-def2-TZVP tightscf CPCM&quot;, numcores=8)

write_nonbonded_FF_for_ligand(fragment=frag, resname=&quot;MCMtest&quot;, charge=0, mult=1,
    coulomb14scale=1.0, lj14scale=1.0, charge_model=&quot;CM5_ORCA&quot;, theory=orcatheory, LJ_model=&quot;UFF&quot;, charmm=True)
</pre></div>
</div>
<p>xTB-example:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>from ash import *

frag=Fragment(xyzfile=&quot;ligand.xyz&quot;)
#Script to get nonbonded model parameters for a ligand
write_nonbonded_FF_for_ligand(fragment=frag, charge=-3, mult=1, resname=&quot;MCMtest&quot;,
    coulomb14scale=1.0, lj14scale=1.0, charge_model=&quot;xTB&quot;, LJ_model=&quot;UFF&quot;, charmm=True)
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p>coulomb14scale and lj14scale parameters can be changed, depending on what other forcefield this ligand-forcefield will be combined with.</p></li>
<li><p>charmm=True keyword writes the forcefield file so that it is compatible with the CHARMM36 forcefield (i.e. containing both a NonbondedForce and LennardJonesForce block)</p></li>
</ul>
<p><strong>NOTES</strong></p>
<ul class="simple">
<li><p>Parameters will be derived for each atom in the XYZ-file. Symmetry is currently not incorporated and this means that very
similar atoms in the structure will have their own charge/LJ parameters. Since this is not always desired, the user
should take care to combine and symmetrize the parameters in the XML-file manually.</p></li>
<li><p>For a ligand bound to the protein, special care must be taken. Charges are best derived from a ligand structure with all metal ions
coordinated (e.g. including an amino acid side chain) but then the calculation will contain those extra atoms.
This requires manual tweaking of the final charges (make sure that the sum of atom charges add up to the correct total charge).</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Explicit-solvation.html" class="btn btn-neutral float-right" title="Explicit solvation (small molecule)" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="crest-interface.html" class="btn btn-neutral float-left" title="CREST interface" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Ragnar Bjornsson.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-XXXXXXX-1', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>