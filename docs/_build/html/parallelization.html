<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Parallelization in ASH &mdash; Ash 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/my_theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="QM Interfaces" href="QM-interfaces.html" />
    <link rel="prev" title="Coordinates and fragments" href="coordinate-input.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> Ash
            <img src="_static/ash-simple-logo-letterbig.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ASH</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="About.html">About ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="basics.html">Basic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic-examples.html">Basic examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="ash_program_philosophy.html">ASH Program Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="coordinate-input.html">Coordinates and fragments</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Parallelization in ASH</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#singlepoint-parallel">Singlepoint_parallel</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="QM-interfaces.html">QM Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="MM-interfaces.html">MM Interfaces</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jobtypes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="job-types.html">Job Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="singlepoint.html">Singlepoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_freq.html">Frequency calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_dynamics.html">Molecular dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="neb.html">Nudged Elastic Band Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="surfacescan.html">Surface Scans</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module_QM-MM.html">QM/MM Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_benchmarking.html">Benchmarking in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_highlevel_workflows.html">Highlevel workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_molcrys.html">MOLCRYS: Automatic QM/MM for Molecular Crystals</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_PES.html">PES: PhotoElectron/PhotoEmission Spectrum</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_plotting.html">Plotting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfaces</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ORCA-interface.html">ORCA interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="xTB-interface.html">xTB interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRCC-interface.html">MRCC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="CFour-interface.html">CFour interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dalton-interface.html">Dalton interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="PySCF-interface.html">PySCF interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Psi4-interface.html">Psi4 interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="crest-interface.html">CREST interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="geomeTRIC-interface.html">geomeTRIC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="knarr-interface.html">KNARR interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="OpenMM-interface.html">OpenMM interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Explicit-solvation.html">Explicit solvation (small molecule)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metalloprotein-I.html">Metalloprotein tutorial I: Rubredoxin</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metalloprotein-II.html">Metalloprotein tutorial II: Ferredoxin</a></li>
<li class="toctree-l1"><a class="reference internal" href="QM-MM-protein.html">QM/MM on a protein</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows-examples.html">Workflow examples in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="Highlevel_CC_CBS_workflows.html">Tutorial: High-level CCSD(T)/CBS workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="coordinate-tools.html">Coordinates and fragment tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ash</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Parallelization in ASH</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/parallelization.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="parallelization-in-ash">
<h1>Parallelization in ASH<a class="headerlink" href="#parallelization-in-ash" title="Permalink to this headline"></a></h1>
<p>ASH can utilize parallelization in a few different ways: either via independent parallelization of the external QM program or MM program or via Python multiprocessing (running independent jobs in parallel).
For example if you create an ORCATheory object with numcores=X option, when ASH tells ORCA to run a calculation, ORCA will launch in parallel mode (as the ORCA inputfile created by ASH will contains parallelization information)
and will run its calculations in parallel using OpenMPI parallelization.
This requires, however, OpenMPI to be set up (define PATH and LD_LIBRARY_PATH) correctly in the environment that ASH runs in (typically the jobscript used to submit calculations to the queuing system).
OpenMM and some QM programs may utilize simpler threads-based parallelization. The number of threads launched is usually controlled by ASH via. numcores=X option.</p>
<p>note: for OpenMM the number of threads needs to be set up outside ASH (jobscript)</p>
<p>Some parts of ASH are parallelized by the Python multiprocessing library. This allows many independent calculations to be run simultaneously via the Pool feature of the multiprocessing library.
ASH modules that use multiprocessing parallelization are currently: NumFreq and Singlepoint_parallel (see below).</p>
<div class="section" id="singlepoint-parallel">
<h2>Singlepoint_parallel<a class="headerlink" href="#singlepoint-parallel" title="Permalink to this headline"></a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">Singlepoint_parallel</span><span class="p">(</span><span class="n">fragments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fragmentfiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">theories</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mofilesdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">allow_theory_parallelization</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</pre></div>
</div>
<p>The Singlepoint_parallel function allows one to run many independent single-point energy jobs in complete parallelization via the Python multiprocessing library.
Typically the QM program parallelization is turned off in this case as it is more efficient to run as many calculations simultaneously as possible with each calculation utilizing a single core.
Example: if you have 120 single-point jobs to do (with roughly equivalent cost) and 24 cores available, it scales perfectly to occupy all CPU cores by 24 jobs at once (each job utilizing 1 core) and thus run through the list of 120 jobs in 5 batches.
This would be faster than running each job 1-by-1 utilizing QM-program parallelization (using 24 cores) as the QM-program parallelization will simply not scale as well (due to intrinsic parallelization limitations of the QM algorithms).
Singlepoint_parallel allows you to conveniently launch such parallelization jobs. The function distinguishes betwen 2 types of Singlepoint jobs: multiple fragments vs. multiple theories</p>
<ul class="simple">
<li><p><strong>multiple fragments with 1 theory</strong></p></li>
</ul>
<p>For the more common case of multiple fragments, you may have a directory of e.g. 120 XYZ-files of different molecules and you want to run a singlepoint-energy job for each one.
To do this using Singlepoint_parallel you would just need to create a list of ASH fragments for each XYZ-file and then pass the list and an ASH Theory level object to Singlepoint_parallel.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Directory of XYZ files. Can be full path or relative path.</span>
<span class="n">xyzdir</span> <span class="o">=</span> <span class="s1">&#39;/path/to/xyz_files&#39;</span>

<span class="n">list_of_molecules</span><span class="o">=</span><span class="p">[]</span>
<span class="c1">#Creating list of ASH fragments from XYZ files. Using filename as label. Using readchargemult=True, charge and mult will be read from header of XYZ-file.</span>
<span class="n">fragments</span> <span class="o">=</span> <span class="n">read_xyzfiles</span><span class="p">(</span><span class="n">xyzdir</span><span class="p">,</span><span class="n">readchargemult</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label_from_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1">#Theory object</span>
<span class="n">ORCAcalc</span> <span class="o">=</span> <span class="n">ORCATheory</span><span class="p">(</span><span class="n">orcasimpleinput</span><span class="o">=</span><span class="s2">&quot;! BP86 def2-SVP def2/J&quot;</span><span class="p">,</span> <span class="n">orcablocks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Calling the Singlepoint_parallel function and providing list of fragments and theory:</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">Singlepoint_parallel</span><span class="p">(</span><span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">,</span> <span class="n">theories</span><span class="o">=</span><span class="p">[</span><span class="n">ORCAcalc</span><span class="p">],</span> <span class="n">numcores</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>NOTE: Here assuming that each XYZ-file has charge/mult information in the header of each file.</p>
<p>molecule=Fragment(xyzfile=file,label=label, readchargemult=true).</p>
<ul class="simple">
<li><p><strong>multiple theories for 1 fragment</strong></p></li>
</ul>
<p>For multiple theories you instead have to create a list of multiple Theory objects to be run on the single fragment.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Fragment for HBr</span>
<span class="n">hbr</span> <span class="o">=</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">xyzfile</span><span class="o">=</span><span class="s2">&quot;hbr.xyz&quot;</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">list_of_fragments</span><span class="o">=</span><span class="p">[</span><span class="n">hbr</span><span class="p">]</span>

<span class="c1">#Create list of ORCATheory objects</span>
<span class="n">list_of_orcaobjects</span><span class="o">=</span><span class="p">[]</span>
<span class="k">for</span> <span class="n">functional</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;B3LYP&#39;</span><span class="p">,</span> <span class="s1">&#39;BP86&#39;</span><span class="p">,</span> <span class="s1">&#39;PBE0&#39;</span><span class="p">,</span> <span class="s1">&#39;M06&#39;</span><span class="p">,</span> <span class="s1">&#39;M06-2X&#39;</span><span class="p">,</span> <span class="s1">&#39;r2SCAN&#39;</span><span class="p">,</span> <span class="s1">&#39;SCAN&#39;</span><span class="p">,</span> <span class="s1">&#39;TPSS&#39;</span><span class="p">,</span> <span class="s1">&#39;PBE&#39;</span><span class="p">,</span> <span class="s1">&#39;PWLDA&#39;</span><span class="p">]:</span>
    <span class="n">ORCAcalc</span> <span class="o">=</span> <span class="n">ORCATheory</span><span class="p">(</span><span class="n">orcasimpleinput</span><span class="o">=</span><span class="s2">&quot;! def2-SVP def2/J &quot;</span><span class="o">+</span><span class="n">functional</span><span class="p">,</span> <span class="n">orcablocks</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">functional</span><span class="p">)</span>
    <span class="n">list_of_orcaobjects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ORCAcalc</span><span class="p">)</span>

<span class="c1">#Calling the Singlepoint_parallel function</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">Singlepoint_parallel</span><span class="p">(</span><span class="n">fragments</span><span class="o">=</span><span class="n">list_of_fragments</span><span class="p">,</span> <span class="n">theories</span><span class="o">=</span><span class="n">list_of_orcaobjects</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p><strong>multiple theories for multiple fragments</strong></p></li>
</ul>
<p>TODO: This is currently not available</p>
<p><strong>Enabling QM-code parallelization</strong></p>
<p>There is also an option that allows both Python multiprocessing parallelization and the QMTheory parallelization to be active in a <strong>Singlepoint_parallel</strong> job. This option is turned off by default but can be enabled by the
allow_theory_parallelization=True keyword argument. However, care needs to be taken to make sure that the number of used CPU cores by ASH does not exceed the number of available CPU cores to the job (e.g. that requested by the queuing system).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">numcores</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1">#Total number of cores used by ASH. Should be equal to poolcores*QMcores. If using the subash script then this line may be grepped.</span>
<span class="n">poolcores</span> <span class="o">=</span> <span class="mi">4</span> <span class="c1">#The cores used by Singlepoint_parallel to run that many simulteaneous jobs</span>
<span class="n">QMcores</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1">#How many cores are available to the external QM-code</span>

<span class="n">xyzfiles_dir</span><span class="o">=</span><span class="s2">&quot;/path/to/xyzfiles&quot;</span>

<span class="c1">#Creating list of ASH fragments from XYZ files. Using filename as label. Using readchargemult=True, charge and mult will be read from header of XYZ-file.</span>
<span class="n">fragments</span> <span class="o">=</span> <span class="n">read_xyzfiles</span><span class="p">(</span><span class="n">xyzfiles_dir</span><span class="p">,</span><span class="n">readchargemult</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label_from_filename</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">orcacalc</span><span class="o">=</span><span class="n">ORCATheory</span><span class="p">(</span><span class="n">orcasimpleinput</span><span class="o">=</span><span class="s2">&quot;! HF def2-SVP&quot;</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="n">QMcores</span><span class="p">)</span>
<span class="n">energydict</span> <span class="o">=</span> <span class="n">Singlepoint_parallel</span><span class="p">(</span><span class="n">theories</span><span class="o">=</span><span class="p">[</span><span class="n">orcacalc</span><span class="p">],</span> <span class="n">fragments</span><span class="o">=</span><span class="n">fragments</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="n">poolcores</span><span class="p">,</span> <span class="n">allow_theory_parallelization</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final energydict:&quot;</span><span class="p">,</span> <span class="n">energydict</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="coordinate-input.html" class="btn btn-neutral float-left" title="Coordinates and fragments" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="QM-interfaces.html" class="btn btn-neutral float-right" title="QM Interfaces" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Ragnar Bjornsson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-XXXXXXX-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>