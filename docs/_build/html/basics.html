<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Basic usage &mdash; Ash 0.1 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/my_theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Basic examples" href="basic-examples.html" />
    <link rel="prev" title="Setup" href="setup.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
            <a href="index.html" class="icon icon-home"> Ash
            <img src="_static/ash-simple-logo-letterbig.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">ASH</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="About.html">About ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Basic usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#input-structure">Input structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-script">Example script</a></li>
<li class="toctree-l2"><a class="reference internal" href="#running-script-directly-in-the-shell">Running script directly in the shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="#interactive-ash-in-a-repl-or-ipython-environment">Interactive ASH in a REPL or iPython environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ash-with-julia-support">ASH with Julia support</a></li>
<li class="toctree-l2"><a class="reference internal" href="#ash-settings">ASH settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-of-colors-in-ash-output">Use of colors in ASH output</a></li>
<li class="toctree-l2"><a class="reference internal" href="#submitting-job">Submitting job</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="basic-examples.html">Basic examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="ash_program_philosophy.html">ASH Program Philosophy</a></li>
<li class="toctree-l1"><a class="reference internal" href="coordinate-input.html">Coordinates and fragments</a></li>
<li class="toctree-l1"><a class="reference internal" href="parallelization.html">Parallelization in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="QM-interfaces.html">QM Interfaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="MM-interfaces.html">MM Interfaces</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Jobtypes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="job-types.html">Job Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="singlepoint.html">Singlepoint</a></li>
<li class="toctree-l1"><a class="reference internal" href="Geometry-optimization.html">Geometry optimization</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_freq.html">Frequency calculation</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_dynamics.html">Molecular dynamics</a></li>
<li class="toctree-l1"><a class="reference internal" href="neb.html">Nudged Elastic Band Method</a></li>
<li class="toctree-l1"><a class="reference internal" href="surfacescan.html">Surface Scans</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Modules</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="module_QM-MM.html">QM/MM Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_Hybrid_Theory.html">Hybrid Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_benchmarking.html">Benchmarking in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_workflows.html">Workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_highlevel_workflows.html">Highlevel workflows</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_molcrys.html">MOLCRYS: Automatic QM/MM for Molecular Crystals</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_PES.html">PES: PhotoElectron/PhotoEmission Spectrum</a></li>
<li class="toctree-l1"><a class="reference internal" href="module_plotting.html">Plotting</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Interfaces</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ORCA-interface.html">ORCA interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="xTB-interface.html">xTB interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="MRCC-interface.html">MRCC interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="CFour-interface.html">CFour interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Dalton-interface.html">Dalton interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="PySCF-interface.html">PySCF interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="Psi4-interface.html">Psi4 interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="crest-interface.html">CREST interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="OpenMM-interface.html">OpenMM interface</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="Explicit-solvation.html">Explicit solvation (small molecule)</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metalloprotein-I.html">Metalloprotein tutorial I: Rubredoxin</a></li>
<li class="toctree-l1"><a class="reference internal" href="Metalloprotein-II.html">Metalloprotein tutorial II: Ferredoxin</a></li>
<li class="toctree-l1"><a class="reference internal" href="QM-MM-protein.html">QM/MM on a protein</a></li>
<li class="toctree-l1"><a class="reference internal" href="workflows-examples.html">Workflow examples in ASH</a></li>
<li class="toctree-l1"><a class="reference internal" href="Highlevel_CC_CBS_workflows.html">Tutorial: High-level CCSD(T)/CBS workflows</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tools</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="coordinate-tools.html">Coordinates and fragment tools</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: white" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Ash</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Basic usage</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/basics.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="basic-usage">
<h1>Basic usage<a class="headerlink" href="#basic-usage" title="Permalink to this headline"></a></h1>
<p>This page shows how to use ASH once you have correctly set up ASH as a Python library.
See <a class="reference internal" href="setup.html"><span class="doc">Setup</span></a> for information on installing ASH.</p>
<div class="section" id="input-structure">
<h2>Input structure<a class="headerlink" href="#input-structure" title="Permalink to this headline"></a></h2>
<p>You create a Python3 script (e.g. called ashtest.py) and import the ASH library:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>   <span class="c1"># This will import the most important ASH functionality into your namespace</span>
<span class="c1">#or</span>
<span class="kn">import</span> <span class="nn">ash</span>   <span class="c1"># If you use this option you will have to add the &quot;ash.&quot; prefix in front of ASH functions/classes.</span>
</pre></div>
</div>
<p>ASH functionality can only be imported if the ASH source dir is in the PYTHONPATH.
Make sure you have already set in the shell (part of Setup):</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>/path/to/ash_dir:<span class="nv">$PYTHONPATH</span>
</pre></div>
</div>
<p>You then have the freedom of writing a Python script in whatever way you prefer but taking the advantage
of ASH functionality. Typically you would first create one (or more) molecule fragments, then define a theory
object and then call a specific job-module (singlepoint, an optimizer, numerical-frequencies etc.).
See  <a class="reference internal" href="basic-examples.html"><span class="doc">Basic examples</span></a> for examples.</p>
</div>
<div class="section" id="example-script">
<h2>Example script<a class="headerlink" href="#example-script" title="Permalink to this headline"></a></h2>
<p>Here is a basic ASH Python script, e.g. named: ashtest.py</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ash</span> <span class="kn">import</span> <span class="o">*</span>

<span class="c1">#Defining a numcores variable with the number of available CPU cores. Will be given to ORCA object.</span>
<span class="n">numcores</span><span class="o">=</span><span class="mi">4</span>
<span class="c1">#Create fragment from a multi-line Python string.</span>
<span class="n">fragstring</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">H 0.0 0.0 0.0</span>
<span class="s2">F 0.0 0.0 1.0</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">molecule</span> <span class="o">=</span> <span class="n">Fragment</span><span class="p">(</span><span class="n">coordsstring</span><span class="o">=</span><span class="n">fragstring</span><span class="p">,</span> <span class="n">charge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mult</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#Defining ORCA-related variables</span>
<span class="n">orcasimpleinput</span><span class="o">=</span><span class="s2">&quot;! BP86 def2-SVP tightscf&quot;</span>
<span class="n">orcablocks</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">cf maxiter 200 end&quot;</span>

<span class="n">ORCAcalc</span> <span class="o">=</span> <span class="n">ORCATheory</span><span class="p">(</span><span class="n">orcasimpleinput</span><span class="o">=</span><span class="n">orcasimpleinput</span><span class="p">,</span> <span class="n">orcablocks</span><span class="o">=</span><span class="n">orcablocks</span><span class="p">,</span> <span class="n">numcores</span><span class="o">=</span><span class="n">numcores</span><span class="p">)</span>

<span class="c1">#Geometry Optimization using geomeTRIC</span>
<span class="n">Optimizer</span><span class="p">(</span><span class="n">fragment</span><span class="o">=</span><span class="n">molecule</span><span class="p">,</span> <span class="n">theory</span><span class="o">=</span><span class="n">ORCAcalc</span><span class="p">,</span> <span class="n">coordsystem</span><span class="o">=</span><span class="s1">&#39;tric&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The script above loads ASH, creates a new fragment from a string (see <a class="reference internal" href="coordinate-input.html"><span class="doc">Coordinates and fragments</span></a> for other ways),
defines variables related to the ORCA-interface , creates an ORCA-theory object
(see <a class="reference internal" href="QM-interfaces.html"><span class="doc">QM Interfaces</span></a> and <a class="reference internal" href="ORCA-interface.html"><span class="doc">ORCA interface</span></a> ), and runs a geometry optimization using the geomeTRICOptimizer optimizer function  (see <a class="reference internal" href="job-types.html"><span class="doc">Job Types</span></a> and <a class="reference internal" href="Geometry-optimization.html"><span class="doc">Geometry optimization</span></a> ).</p>
</div>
<div class="section" id="running-script-directly-in-the-shell">
<h2>Running script directly in the shell<a class="headerlink" href="#running-script-directly-in-the-shell" title="Permalink to this headline"></a></h2>
<p>For a very simple short job we can just run the script directly</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python3 ashtest.py
</pre></div>
</div>
<p>The output will be written to standard output (i.e. your shell).
To save the output it is better to redirect the output to a file.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>python3 ashtest.py &gt;<span class="p">&amp;</span> ashtest.out
</pre></div>
</div>
<p>For a really long job you would typically submit a jobscript to a queuing system instead.</p>
</div>
<div class="section" id="interactive-ash-in-a-repl-or-ipython-environment">
<h2>Interactive ASH in a REPL or iPython environment<a class="headerlink" href="#interactive-ash-in-a-repl-or-ipython-environment" title="Permalink to this headline"></a></h2>
<p>It is also possible to run ASH within a read-eval-print-loop environment such as iPython.
This allows for interactive use of ASH. See video below for an example.</p>
<p>If ASH has been set up correctly (PYTHONPATH etc.) and iPython is available (pip install ipython), then ASH within iPython should be straightforward.
Make sure to use the iPython that uses the same Python as ASH.</p>
 <div align=center>
<script id="asciicast-MUrhNGhDx9mAjdqomBppIGWsI" src="https://asciinema.org/a/MUrhNGhDx9mAjdqomBppIGWsI.js" async></script>
 </div></div>
<div class="section" id="ash-with-julia-support">
<h2>ASH with Julia support<a class="headerlink" href="#ash-with-julia-support" title="Permalink to this headline"></a></h2>
<p>Some ASH functionality (primarily the molecular crystal QM/MM code) requires a working Python-Julia interface as some of the Python routines are too slow.
ASH can use both <a class="reference external" href="https://cjdoris.github.io/PythonCall.jl/stable/pycall/">PythonCall</a> and <a class="reference external" href="https://pyjulia.readthedocs.io/en/latest/">PyJulia</a>
The PythonCall/juliacall library is recommended.</p>
</div>
<div class="section" id="ash-settings">
<h2>ASH settings<a class="headerlink" href="#ash-settings" title="Permalink to this headline"></a></h2>
<p>Global settings are stored in  <em>/path/to/ash/ash/settings_ash.py</em> and can in principle be modified. However, it is better to instead create a settings file called <strong>ash_user_settings.ini</strong> for your user in your home-directory that should look like below.
Here you can set whether to use ANSI colors in output, whether to print inputfile and logo, timings etc.
ASH will attempt to read this file on startup.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Settings]
scale = 1.0
tol = 0.2
use_ANSI_color = True
print_input = True
print_logo = True
load_julia = True
julia_library = pythoncall #pyjulia is another option
debugflag = False
print_exit_footer = True
print_full_timings = True
nonbondedMM_code = julia
connectivity_code = julia
print_exit_footer = True
print_full_timings = True
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The file ~/ash_user_settings.ini should not contain ‘ or “” symbols when defining strings.</p>
</div>
<p>In addition to options above it is also possible to specify the paths to various external codes.
If these paths are set in the settings file, one can avoid defining them in the inputfiles.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>[Settings]
orcadir = /path/to/orcadir
daltondir = /path/to/daltondir
xtbdir = /path/to/xtbdir
psi4dir = /path/to/psi4dir
cfourdir = /path/to/cfourdir
crestdir = /path/to/crestdir
</pre></div>
</div>
</div>
<div class="section" id="use-of-colors-in-ash-output">
<h2>Use of colors in ASH output<a class="headerlink" href="#use-of-colors-in-ash-output" title="Permalink to this headline"></a></h2>
<p>ASH can display ANSI colors in output if  use_ANSI_color = True   is used in the settings file (see above).
This makes the output more readable.</p>
<p>Note, however, that colors will only display properly if using a text reader that supports it:</p>
<div class="line-block">
<div class="line">- less may require the -R flag: less -R outputfile. Or setting: export LESS=-R</div>
<div class="line">- vim and emacs require plugins</div>
</div>
</div>
<div class="section" id="submitting-job">
<h2>Submitting job<a class="headerlink" href="#submitting-job" title="Permalink to this headline"></a></h2>
<p>For a more complicated job we would probably want to create a job-script that would handle various environmental variables,
dealing with local scratch, copy files back when done etc.
Here is an example SLURM jobscript. Remember to go through all the lines and change the various things like the path to
local scratch, set the correct PATH variables, load modules etc.</p>
<p>Use like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sbatch -J ashtest.py jobscript.sh
</pre></div>
</div>
<p>where jobscript.sh is:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/zsh</span>

<span class="c1">#SBATCH -N 1</span>
<span class="c1">#SBATCH --tasks-per-node=1</span>
<span class="c1">#SBATCH --time=8760:00:00</span>
<span class="c1">#SBATCH -p compute</span>
<span class="c1">#SBATCH --mem-per-cpu=3000</span>

<span class="c1">#Use like this:</span>
<span class="c1">#sbatch -J inputfile.py jobscript.sh</span>

<span class="nb">export</span> <span class="nv">job</span><span class="o">=</span><span class="nv">$SLURM_JOB_NAME</span>
<span class="nb">export</span> <span class="nv">job</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="si">${</span><span class="nv">job</span><span class="p">%%.*</span><span class="si">}</span><span class="k">)</span>
<span class="nv">outputname</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$job</span><span class="s2">.out&quot;</span>

<span class="c1">#Controlling threading</span>
<span class="nb">export</span> <span class="nv">MKL_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">OMP_NUM_THREADS</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span> <span class="nv">OMP_STACKSIZE</span><span class="o">=</span>1G
<span class="nb">export</span> <span class="nv">OMP_MAX_ACTIVE_LEVELS</span><span class="o">=</span><span class="m">1</span>

<span class="c1">#Create scratch directory on local scratch</span>
<span class="nv">path_to_scratch</span><span class="o">=</span>/scratch
<span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$path_to_scratch</span>/<span class="nv">$USER</span> <span class="o">]</span>
<span class="k">then</span>
  mkdir -p <span class="nv">$path_to_scratch</span>/<span class="nv">$USER</span>
<span class="k">fi</span>
<span class="nv">tdir</span><span class="o">=</span><span class="k">$(</span>mktemp -d <span class="nv">$path_to_scratch</span>/<span class="nv">$USER</span>/ashjob__<span class="nv">$SLURM_JOB_ID</span>-XXXX<span class="k">)</span>
chmod +xr <span class="nv">$tdir</span>


<span class="c1">#Copy all relevant inputfiles for ASH: python scripts, CIF-files, XYZ files etc.</span>
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.py <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.cif <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.xyz <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.xtl <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.ff <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.ygg <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.pdb <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.hess <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/*.info <span class="nv">$tdir</span>/
cp <span class="nv">$SLURM_SUBMIT_DIR</span>/Centralmainfrag <span class="nv">$tdir</span>/

<span class="c1"># cd to scratch</span>
<span class="nb">cd</span> <span class="nv">$tdir</span>
<span class="nb">echo</span> <span class="s2">&quot;tdir is </span><span class="nv">$tdir</span><span class="s2">&quot;</span>

<span class="c1"># Copy job and node info to beginning of outputfile</span>
<span class="nb">echo</span> <span class="s2">&quot;Starting job in scratch dir: </span><span class="nv">$tdir</span><span class="s2">&quot;</span> &gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span>
<span class="nb">echo</span> <span class="s2">&quot;Job execution start: </span><span class="k">$(</span>date<span class="k">)</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span>
<span class="nb">echo</span> <span class="s2">&quot;Shared library path: </span><span class="nv">$LD_LIBRARY_PATH</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span>
<span class="nb">echo</span> <span class="s2">&quot;Slurm Job ID is: </span><span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span>
<span class="nb">echo</span> <span class="s2">&quot;Slurm Job name is: </span><span class="si">${</span><span class="nv">SLURM_JOB_NAME</span><span class="si">}</span><span class="s2">&quot;</span> &gt;&gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span>
<span class="nb">echo</span> <span class="nv">$SLURM_NODELIST</span> &gt;&gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span>

<span class="c1">#Python and ASH environment</span>

<span class="c1">#Load necessary modules.</span>
<span class="c1">#If using modules for Python/OpenMPI/ORCA etc. then that all should be loaded here.</span>

<span class="c1"># Load or set Python environment here:</span>
<span class="c1"># e.g. module load python37  or:</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/path/to/python/bin:<span class="nv">$PATH</span>
<span class="c1"># If using Conda, activate desired Conda environment.</span>
<span class="c1"># May have to add conda bin directory to $PATH first.</span>
<span class="c1">#conda activate ashpy37</span>



<span class="c1">#Add path to Julia</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/path/to/julia/bin:<span class="nv">$PATH</span>

<span class="c1">#Put ASH in PYTHONPATH and LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">PYTHONPATH</span><span class="o">=</span>/path/to/dir-containing-ash-dir:<span class="nv">$PYTHONPATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/path/to/ash:/path/to/ash/lib:<span class="nv">$LD_LIBRARY_PATH</span>

<span class="c1">#Print out environment variables for debuggin.</span>
<span class="nb">echo</span> <span class="s2">&quot;PATH is </span><span class="nv">$PATH</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;PYTHONPATH is </span><span class="nv">$PYTHONPATH</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;LD_LIBRARY_PATH is </span><span class="nv">$LD_LIBRARY_PATH</span><span class="s2">&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;Running Ash  job&quot;</span>

<span class="c1">#Put ORCA in PATH and LD_LIBRARY_PATH</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/path/to/orca:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/path/to/orca:<span class="nv">$LD_LIBRARY_PATH</span>

<span class="c1">#OpenMPI path for ORCA</span>
<span class="nb">export</span> <span class="nv">PATH</span><span class="o">=</span>/opt/openmpi-2.1.5/bin:<span class="nv">$PATH</span>
<span class="nb">export</span> <span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span>/opt/openmpi-2.1.5/lib:<span class="nv">$LD_LIBRARY_PATH</span>


<span class="c1">#Start Ash job from scratch dir.  Output file is written directly to submit directory</span>
<span class="nb">export</span> <span class="nv">PYTHONUNBUFFERED</span><span class="o">=</span><span class="m">1</span>
python3 <span class="nv">$job</span>.py &gt;&gt; <span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="nv">$outputname</span> <span class="m">2</span>&gt;<span class="p">&amp;</span><span class="m">1</span>

<span class="c1"># Ash has finished. Now copy important stuff back.</span>
<span class="nv">outputdir</span><span class="o">=</span><span class="nv">$SLURM_SUBMIT_DIR</span>/<span class="si">${</span><span class="nv">job</span><span class="si">}</span>_<span class="si">${</span><span class="nv">SLURM_JOB_ID</span><span class="si">}</span>
cp -r <span class="nv">$tdir</span> <span class="nv">$outputdir</span>

<span class="c1"># Removing scratch folder</span>
rm -rf <span class="nv">$tdir</span>
</pre></div>
</div>
<p>For even more convenient job-submissions one can utilize a <strong>subash</strong> wrapper script that copies the jobscript.sh file (above)
to the current directory, modifies the number of cores requested and then submits.
The number of cores can be provided in the command-line (should match the number of cores requested in the ASH Python script, e.g. as in ashtest.py above)
or alternatively it can read the numcores variable in ashtest.py (if present). For the latter: make sure to have a line containing:
“numcores=X”
in the Python script (as in ashtest.py above).
Make sure to change path_to_jobscript variable in line 5.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>subash ashtest.py
<span class="c1"># or:</span>
subash ashtest.py -p <span class="m">8</span>  <span class="c1">#for requesting an 8-core job.</span>
</pre></div>
</div>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/zsh</span>
<span class="c1">#subash</span>
<span class="c1">#Wrapper script for ASH job-script</span>

<span class="nv">path_to_jobscript</span><span class="o">=</span>/home/bjornsson/jobscripts/job-ash.sh

<span class="nv">green</span><span class="o">=</span><span class="sb">`</span>tput setaf <span class="m">2</span><span class="sb">`</span>
<span class="nv">yellow</span><span class="o">=</span><span class="sb">`</span>tput setaf <span class="m">3</span><span class="sb">`</span>
<span class="nv">normal</span><span class="o">=</span><span class="sb">`</span>tput sgr0<span class="sb">`</span>
<span class="nv">cyan</span><span class="o">=</span><span class="sb">`</span>tput setaf <span class="m">6</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$1</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span>
<span class="k">then</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">green</span><span class="si">}</span><span class="s2">subash</span><span class="si">${</span><span class="nv">normal</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">yellow</span><span class="si">}</span><span class="s2">Usage: subash input.py      Dir should contain .py Python script.</span><span class="si">${</span><span class="nv">normal</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">yellow</span><span class="si">}</span><span class="s2">Or: subash input.py -p 8      Submit with 8 cores.</span><span class="si">${</span><span class="nv">normal</span><span class="si">}</span><span class="s2">&quot;</span>
  <span class="nb">exit</span>
<span class="k">fi</span>

<span class="nb">export</span> <span class="nv">file</span><span class="o">=</span><span class="nv">$1</span>


<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;</span><span class="nv">$2</span><span class="s2">&quot;</span> <span class="o">==</span> <span class="s2">&quot;-p&quot;</span> <span class="o">]]</span>
<span class="k">then</span>
  <span class="nb">export</span> <span class="nv">NPROC</span><span class="o">=</span><span class="nv">$3</span>
<span class="k">else</span>
  <span class="c1">#Grabbing numcores from input-file.py if not using -p flag</span>
  <span class="nb">echo</span> <span class="s2">&quot;No -p N provided. Grabbing cores from Python script (searches for line beginning with numcores= )&quot;</span>
  <span class="nv">var</span><span class="o">=</span><span class="k">$(</span>grep <span class="s1">&#39;^numcores&#39;</span> <span class="nv">$file</span><span class="k">)</span>
  <span class="nb">export</span> <span class="nv">NPROC</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$var</span> <span class="p">|</span> awk -F<span class="s1">&#39;=&#39;</span> <span class="s1">&#39;{print $2}&#39;</span><span class="k">)</span>
  <span class="c1">#export NPROC=$(grep -m 1 numcores $file | awk -F&#39;=&#39; &#39;{print $2}&#39;)</span>
  <span class="k">if</span> <span class="o">((</span><span class="si">${#</span><span class="nv">NPROC</span><span class="si">}</span> <span class="o">==</span> <span class="m">0</span><span class="o">))</span>
  <span class="k">then</span>
    <span class="nb">echo</span> <span class="s2">&quot;No numcores variable in Python script found. Exiting...&quot;</span>
    <span class="nb">exit</span>
  <span class="k">fi</span>
<span class="k">fi</span>

<span class="c1">#Copying job-script to dir:</span>
cp <span class="nv">$path_to_jobscript</span> .
<span class="c1">#Note: jobscript should have tasks-per-node set to 1 for the sed substitution to work</span>
sed -i <span class="s2">&quot;s/#SBATCH --tasks-per-node=1/#SBATCH --tasks-per-node=</span><span class="nv">$NPROC</span><span class="s2">/g&quot;</span> job-ash.sh

<span class="c1">#Submit job.</span>
sbatch -J <span class="nv">$file</span> job-ash.sh
<span class="nb">echo</span> <span class="s2">&quot;</span><span class="si">${</span><span class="nv">cyan</span><span class="si">}</span><span class="s2">ASH job submitted using </span><span class="nv">$NPROC</span><span class="s2"> cores using file </span><span class="nv">$file</span><span class="s2">.</span><span class="nv">$mult</span><span class="s2"> </span><span class="si">${</span><span class="nv">normal</span><span class="si">}</span><span class="s2">&quot;</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="setup.html" class="btn btn-neutral float-left" title="Setup" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="basic-examples.html" class="btn btn-neutral float-right" title="Basic examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2020, Ragnar Bjornsson.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-XXXXXXX-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-XXXXXXX-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>